services:
  state-db:
    image: "redis:alpine"
    command: redis-server --requirepass ${STATE_DB_PASSWORD}
    networks:
      - botnet
    ports:
      - 6379:6379
    environment:
      - REDIS_REPLICATION_MODE=master

  main-container:
    image: main-container
    restart: unless-stopped
    networks:
      - botnet
    ports:
      - 8000:80
    environment:
      - BASE_URL=${BASE_URL}
      - TWITCH_SUPER_ADMIN_USERNAME=${TWITCH_SUPER_ADMIN_USERNAME}
      - TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID}
      - TWITCH_SECRET=${TWITCH_SECRET}
      - SESSION_SECRET=${SESSION_SECRET}
      - STATE_DB_PASSWORD=${STATE_DB_PASSWORD}
      - STATE_DB_URL=redis://state-db:6379
      - PROXY_OVERRIDES={"jjvanvan":"http://tenant-container-jjvanvan:80","minecraft1167890":"http://tenant-container-minecraft1167890:80"}

  tenant-container-jjvanvan:
    image: tenant-container
    restart: unless-stopped
    networks:
      - botnet
    environment:
      - TWITCH_CHANNEL=jjvanvan
      - TWITCH_BOT_USERNAME=${TWITCH_BOT_USERNAME}
      - TWITCH_BOT_OAUTH_TOKEN=${TWITCH_BOT_OAUTH_TOKEN}

      - BASE_URL=${BASE_URL}
      - TWITCH_SUPER_ADMIN_USERNAME=${TWITCH_SUPER_ADMIN_USERNAME}
      - TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID}
      - TWITCH_SECRET=${TWITCH_SECRET}
      - SESSION_SECRET=${SESSION_SECRET}
      - STATE_DB_PASSWORD=${STATE_DB_PASSWORD}
      - STATE_DB_URL=redis://state-db:6379

  tenant-container-minecraft1167890:
    image: tenant-container
    restart: unless-stopped
    networks:
      - botnet
    environment:
      - TWITCH_CHANNEL=minecraft1167890
      - TWITCH_BOT_USERNAME=${TWITCH_BOT_USERNAME}
      - TWITCH_BOT_OAUTH_TOKEN=${TWITCH_BOT_OAUTH_TOKEN}

      - BASE_URL=${BASE_URL}
      - TWITCH_SUPER_ADMIN_USERNAME=${TWITCH_SUPER_ADMIN_USERNAME}
      - TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID}
      - TWITCH_SECRET=${TWITCH_SECRET}
      - SESSION_SECRET=${SESSION_SECRET}
      - STATE_DB_PASSWORD=${STATE_DB_PASSWORD}
      - STATE_DB_URL=redis://state-db:6379

# docker network create botnet
networks:
  botnet:
    external: true
