<!doctype html>
<html>
    <head>
        <title>twitch nicknames</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/static/style.css">
    </head>
    <body>
        <div id="app">
            <div id="nicknames_container">
                <h1>Nickname Ledger</h1>
                <span v-if="channels.length > 1 || !channel">
                    Channels:
                    <span v-for="c, i in channels">
                        <span v-if="i > 0"> | </span>
                        <span v-if="c === channel" style="font-weight: bold">{{c}}</span>
                        <a v-else :href="'#' + c">{{c}}</a>
                    </span>
                </span>
                <span v-if="channel">
                    <p>Use <code>!setnickname</code> in {{channel}}'s chat to show up here!</p>
                        <ul id="nicknames">
                        <li v-for="username in Object.keys(nicknames)" :style="{ color: compute_color(username) }">
                            <span class="nickname">{{nicknames[username]}}</span>
                            <span class="equals"> = </span>
                            <span class="username">{{username}}</span>
                        </li>
                    </ul>
                </span>
            </div>

            <div id="chat">
                <div id="chat-header">
                    <h2>Chat</h2>
                    <label><input type="checkbox" v-model="only_show_nicknames"> only show chat from people with nicknames</label>
                </div>
                <ul id="messages">
                    <li v-for="msg in chat" :style="{ display: (!only_show_nicknames || msg.nickname) ? '' : 'none' }">
                        <span class="nickname" :style="{ color: compute_color(msg.username) }">{{msg.nickname || msg.username}}</span>
                        <span class="colon">: </span>
                        <span class="chat_text">{{msg.text}}</span>
                    </li>
                </ul>
            </div>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        <script src="/vue.js"></script>
        <script src="/color-hash.js"></script>

        <script>
const { createApp, ref } = Vue

createApp({
    data() {return {
        socket: undefined,
        channel: undefined,
        channels: [],
        nicknames: {},
        chat: [],
        only_show_nicknames: true,
        colorHash: new ColorHash({lightness: [0.5,0.6,0.7,0.8], saturation: [0.6,0.7,0.8,0.9,1]}),
    }},
    methods: {
        compute_color(text) {
            return this.colorHash.hex(text+"....");
        },
        socket_connect() {
            console.log('socket connected');
            this.socket.emit('init', {'channel': this.channel});
        },
        socket_error() {
            console.log('socket error');
        },
        socket_nickname(msg) {
            console.log('nickname: ', msg);
            if (msg.nickname === undefined) {
                delete this.nicknames[msg.username];
            } else {
                this.nicknames[msg.username] = msg.nickname;
            }
            this.chat.map(m => {
                if (m.username === msg.username) {
                    m.nickname = msg.nickname;
                }
                return m;
            })
        },
        socket_chat_message(msg) {
            console.log('chat: ', msg);
            this.chat.push(msg);
            const messages = document.querySelector('#messages');
            this.$nextTick(() => {
                messages.scrollTo(0, messages.scrollHeight);
            });
        },
        load_from_local_url() {
            this.channel = window.location.href.split('#')[1]?.toLowerCase();
            if (this.channel) {
                window.location = '#' + this.channel;
            }
        }
    },
    mounted() {
        this.load_from_local_url();

        //whenever the user goes forward/back in history, re-read from the local url
        addEventListener('popstate', event => {
            this.load_from_local_url();
        });

        fetch('/channels.json')
        .then(res => res.json())
        .then(json => this.channels = json);
    },
    watch: {
        channel(new_channel, old_channel) {
            if (this.socket) {
                this.socket.disconnect();
            }
            this.chat = []
            this.nicknames = {}

            if (this.channel) {
                this.socket = io();

                this.socket.on('connect', this.socket_connect);
                this.socket.on('connect_failed', this.socket_error);
                this.socket.on('disconnect', this.socket_error);

                console.log(new_channel + '/nickname', new_channel + '/chat')
                this.socket.on(new_channel + '/nickname', this.socket_nickname);
                this.socket.on(new_channel + '/chat', this.socket_chat_message);
            }
        },
    },
}).mount('#app')
        </script>
    </body>
</html>
